name: Playwright Tests

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        browser: [chromium, firefox, webkit]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Install Playwright browsers
      run: npx playwright install --with-deps ${{ matrix.browser }}
    
    - name: Run Playwright tests
      run: npx playwright test --project=${{ matrix.browser }}
      env:
        CI: true
    
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-report-${{ matrix.browser }}
        path: playwright-report/
        retention-days: 30
    
    - name: Upload test artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-${{ matrix.browser }}
        path: test-results/
        retention-days: 30
    
    - name: Generate test summary
      if: always()
      run: |
        echo "## Test Results (${{ matrix.browser }})" >> $GITHUB_STEP_SUMMARY
        if [ -f test-results/results.json ]; then
          echo "Test results available in artifacts" >> $GITHUB_STEP_SUMMARY
        fi

  notify:
    needs: test
    runs-on: ubuntu-latest
    if: always()
    steps:
    - name: Send Slack notification
      if: ${{ vars.SLACK_WEBHOOK_URL != '' }}
      uses: slackapi/slack-github-action@v1.25.0
      with:
        payload: |
          {
            "text": "Playwright Tests ${{ needs.test.result }}",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*Playwright Test Results*\nStatus: ${{ needs.test.result }}\nBranch: ${{ github.ref_name }}\nCommit: ${{ github.sha }}\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run>"
                }
              }
            ]
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
    
    - name: Send Email notification
      if: ${{ secrets.EMAIL_TO != '' }}
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: ${{ secrets.EMAIL_SERVER }}
        server_port: ${{ secrets.EMAIL_PORT || '587' }}
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "Playwright Tests ${{ needs.test.result }} - ${{ github.repository }}"
        to: ${{ secrets.EMAIL_TO }}
        from: ${{ secrets.EMAIL_FROM || secrets.EMAIL_USERNAME }}
        body: |
          Playwright Test Results
          
          Repository: ${{ github.repository }}
          Branch: ${{ github.ref_name }}
          Commit: ${{ github.sha }}
          Status: ${{ needs.test.result }}
          
          View full results: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
